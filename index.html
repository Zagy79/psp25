<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vstupenky – QR platba</title>
  <style>
    :root{ --bg:#0b0b10; --txt:#e8ecf1; --muted:#9aa3b2; --card:#12131a; }
    *{box-sizing:border-box}
    html, body{margin:0; padding:0; background:var(--bg); color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    a{color:inherit; text-decoration:none}

    /* SEKCE 1 – plakát přes celou obrazovku */
    .hero{ min-height:100svh; display:grid; place-items:center; background:#000; }
    .hero img{
      display:block; max-width:100vw; max-height:100svh; width:auto; height:auto; object-fit:contain;
      border-radius:10px; box-shadow:0 20px 60px rgba(0,0,0,.5);
    }

    /* SEKCE 2 – cena + výběr počtu */
    .panel{
      padding:28px 16px; display:grid; place-items:center;
      background: radial-gradient(1200px 700px at 70% -10%, #1a2238 0%, var(--bg) 50%);
      border-top:1px solid rgba(255,255,255,.06);
    }
    .card{
      width:min(900px,100%);
      background: color-mix(in srgb, var(--card) 90%, black 10%);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px; padding:18px; box-shadow:0 20px 50px rgba(0,0,0,.35);
    }
    h1{margin:6px 0 8px; font-size:clamp(22px,2.4vw,30px)}
    p.lead{margin:0 0 10px; color:var(--muted)}
    label{display:block; font-size:14px; color:var(--muted); margin-bottom:6px}
    select{
      width:100%; padding:12px 14px; border-radius:12px;
      background:#0f1118; color:var(--txt); border:1px solid rgba(255,255,255,.12);
      font-size:16px; outline:none;
    }
    .total{
      display:flex; align-items:center; justify-content:space-between;
      background:#0f1118; border:1px solid rgba(255,255,255,.12);
      border-radius:12px; padding:12px 14px; font-weight:600; margin-top:12px;
    }
    .total small{color:var(--muted); font-weight:500}

    /* SEKCE 3 – QR platba */
    .qr-wrap{
      margin-top:20px; display:grid; gap:12px; place-items:center;
      padding:16px; border-radius:16px; background:#0f1118; border:1px solid rgba(255,255,255,.12);
    }
    .qr{ width: clamp(180px, 28vw, 320px); /* výška dodá lib. prvek */ }
    /* ✅ Důležité pro Safari: vynutit rozměr vygenerovaného prvku */
    .qr canvas, .qr img{ display:block; width:100% !important; height:auto !important }
    .meta{ font-size:12px; color:var(--muted); text-align:center; word-break:break-all; max-width:720px }
    .grid2{ display:grid; gap:10px }
    @media (min-width:680px){ .grid2{ grid-template-columns:1fr auto } }

    .btns{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:10px }
    button{
      appearance:none; cursor:pointer; font-weight:600; font-size:13px;
      padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.16);
      background:#151826; color:#fff;
    }
    .hint{font-size:12px; color:var(--muted); text-align:center}
    .bankline{font-feature-settings:"tnum" 1; font-variant-numeric: tabular-nums}
  </style>

  <!-- Knihovna QRCodeJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
          integrity="sha512-JWx8nGZ9gC5W0v7x1KOCV3wYt2zq4Rz5Qb7Q9sSNK4f8vWgE5bRr7n8rE56+z7Dq4X3Z5YpQ2Vb1q4KfRNZ0Zg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>

  <!-- SEKCE 1: PLAKÁT -->
  <section class="hero">
    <img src="plakat.png" alt="Plakát" loading="lazy">
  </section>

  <!-- SEKCE 2: CENA + VÝBĚR POČTU -->
  <section class="panel">
    <div class="card">
      <h1>Cena lístku 200 Kč</h1>
      <p class="lead">Vyberte počet lístků, QR platba se dopočítá automaticky.</p>

      <label for="qty">Kolik chcete objednat lístků:</label>
      <select id="qty">
        <option value="1" selected>1 ks</option><option value="2">2 ks</option>
        <option value="3">3 ks</option><option value="4">4 ks</option>
        <option value="5">5 ks</option><option value="6">6 ks</option>
        <option value="7">7 ks</option><option value="8">8 ks</option>
        <option value="9">9 ks</option><option value="10">10 ks</option>
      </select>

      <div class="total">
        <div>Celkem k úhradě<br><small>200 Kč × <span id="qtty">1</span> ks</small></div>
        <div style="font-size:clamp(18px,2.6vw,28px)"><span id="sum">200</span> Kč</div>
      </div>

      <!-- SEKCE 3: QR PLATBA -->
      <div class="qr-wrap">
        <div id="qr" class="qr" aria-label="QR kód platby"></div>

        <div class="grid2" style="align-items:center">
          <div class="bankline">
            <div><strong>Účet:</strong> 4373703073/0800</div>
            <div><strong>IBAN:</strong> CZ75&nbsp;0800&nbsp;0000&nbsp;0043&nbsp;7370&nbsp;3073</div>
            <div><strong>VS:</strong> 2025 &nbsp;|&nbsp; <strong>Měna:</strong> CZK</div>
            <div><strong>Zpráva:</strong> <span id="msg">Lístky 1 ks</span></div>
          </div>
          <div class="btns">
            <button id="dlQR" type="button">Stáhnout QR</button>
            <button id="copySPD" type="button">Kopírovat SPD</button>
          </div>
        </div>

        <div class="meta">
          <strong>Obsah (SPD):</strong>
          <div id="raw"></div>
        </div>
      </div>

      <p class="hint">Standard: Short Payment Descriptor 1.0 (QR Platba). Většina CZ bank aplikací podporuje.</p>
    </div>
  </section>

<script>
/* ===== Konstanty dle zadání ===== */
const TICKET_PRICE = 200;
const IBAN = 'CZ7508000000004373703073';   // 4373703073/0800
const VARIABLE_SYMBOL = '2025';
const CURRENCY = 'CZK';

/* ===== Pomocné funkce ===== */
function amountCZK(qty){ return (Number(qty) * TICKET_PRICE).toFixed(2); }
function msgText(qty){ return `Lístky ${qty} ks`; }
function normalizeIBAN(v){ return (v||'').toUpperCase().replace(/[^A-Z0-9]/g,''); }
function buildSPD({iban, amount, vs, msg}){
  const p = ['SPD*1.0'];
  const acc = normalizeIBAN(iban); if(!acc) return '';
  p.push('ACC:'+acc);
  if(amount) p.push('AM:'+amount);
  p.push('CC:'+CURRENCY);
  if(vs) p.push('X-VS:'+String(vs).replace(/\D/g,'').slice(0,10));
  if(msg) p.push('MSG:'+String(msg).replace(/[\r\n]+/g,' ').slice(0,60));
  return p.join('*');
}

/* ✅ Nezávislá velikost QR – podle okna, ne prvku (Safari fix) */
function computeQRSize(){
  const vw = Math.max(document.documentElement.clientWidth||0, window.innerWidth||0);
  const size = Math.round(vw * 0.28);            // ~28 % šířky okna
  return Math.max(180, Math.min(320, size));     // 180–320 px
}

/* ===== Render ===== */
const qtyEl = document.getElementById('qty');
const sumEl = document.getElementById('sum');
const qttyEl = document.getElementById('qtty');
const msgEl = document.getElementById('msg');
const rawEl = document.getElementById('raw');
const qrBox = document.getElementById('qr');

function render(qty){
  const amount = amountCZK(qty);
  const spd = buildSPD({ iban: IBAN, amount, vs: VARIABLE_SYMBOL, msg: msgText(qty) });

  sumEl.textContent = (Number(amount)).toLocaleString('cs-CZ', { maximumFractionDigits: 0 });
  qttyEl.textContent = qty;
  msgEl.textContent = `Lístky ${qty} ks`;
  rawEl.textContent = spd;

  // QR
  qrBox.innerHTML = '';
  const size = computeQRSize();
  new QRCode(qrBox, { text: spd, width: size, height: size, correctLevel: QRCode.CorrectLevel.M });
}

/* ===== Události ===== */
qtyEl.addEventListener('change', () => render(qtyEl.value));
window.addEventListener('resize', () => { clearTimeout(window._rT); window._rT=setTimeout(()=>render(qtyEl.value),150); });

/* ✅ Stáhnout QR – funguje pro CANVAS i IMG (Safari) */
document.getElementById('dlQR').addEventListener('click', ()=>{
  const canvas = qrBox.querySelector('canvas');
  const img = qrBox.querySelector('img');
  let dataURL = null;

  if(canvas){
    dataURL = canvas.toDataURL('image/png');
  } else if(img){
    const c = document.createElement('canvas');
    c.width = img.naturalWidth || computeQRSize();
    c.height = img.naturalHeight || computeQRSize();
    const ctx = c.getContext('2d');
    // když by Safari vrátilo 0×0, nakreslíme podle aktuálního zobrazení
    const w = c.width || qrBox.clientWidth || computeQRSize();
    const h = c.height || w;
    c.width = w; c.height = h;
    ctx.drawImage(img, 0, 0, w, h);
    dataURL = c.toDataURL('image/png');
  }
  if(!dataURL) return;
  const a = document.createElement('a');
  a.href = dataURL; a.download = 'qr-platba.png'; a.click();
});

/* Kopírovat SPD */
document.getElementById('copySPD').addEventListener('click', async ()=>{
  try{
    await navigator.clipboard.writeText(rawEl.textContent);
    alert('SPD zkopírováno do schránky.');
  }catch(e){ alert('Nepodařilo se zkopírovat.'); }
});

/* Start */
render(qtyEl.value);
</script>
</body>
</html>
