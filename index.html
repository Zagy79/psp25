<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vstupenky</title>
  <style>
    :root{ --bg:#000; --txt:#e8ecf1; --muted:#9aa3b2; }
    *{box-sizing:border-box}
    html, body{ margin:0; padding:0; background:var(--bg); color:var(--txt);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; }

    /* SEKCE 1 – plakát */
    .hero{ min-height:100svh; display:grid; place-items:center; background:#000; }
    .hero img{ display:block; max-width:100vw; max-height:100svh; width:auto; height:auto;
      object-fit:contain; border-radius:10px; box-shadow:0 20px 60px rgba(0,0,0,.5); }

    /* SEKCE 2 – cena + formulář */
    .panel{ padding:20px 16px 50px; display:grid; place-items:center; background:#000;
      border-top:1px solid rgba(255,255,255,.06); }
    .card{ width:min(900px,100%); background:#000; border:1px solid rgba(255,255,255,.08);
      border-radius:18px; padding:18px; box-shadow:0 20px 50px rgba(0,0,0,.35); }
    h1{ text-align:center; margin:6px 0 22px; font-size:clamp(22px,2.4vw,30px); }
    label{ display:block; font-size:14px; color:var(--muted); margin-bottom:6px; }
    input, select{ width:100%; padding:12px 14px; border-radius:12px; background:#0f0f0f; color:#fff;
      border:1px solid rgba(255,255,255,.12); font-size:16px; outline:none; margin-bottom:14px; }
    .total{ display:flex; align-items:center; justify-content:space-between; background:#0f0f0f;
      border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:12px 14px; font-weight:600; margin-top:12px; }
    .total small{ color:var(--muted); font-weight:500; }

    /* SEKCE 3 – QR */
    .qr-wrap{ margin-top:40px; display:grid; place-items:center; padding:20px; background:#000; }
    .qr-box{ width:clamp(200px, 35vw, 320px); margin-bottom:20px; }
    .qr-box img{ display:block; width:100%; height:auto; border-radius:8px; background:#fff; }
    .btns{ display:flex; flex-direction:column; gap:10px; align-items:center; }
    button{ appearance:none; cursor:pointer; font-weight:600; font-size:15px; padding:10px 18px;
      border-radius:10px; border:1px solid rgba(255,255,255,.16); background:#151826; color:#fff;
      width:fit-content; min-width:240px; }
    button:hover{ background:#1f2433; }
  </style>
</head>
<body>

  <!-- SEKCE 1: PLAKÁT -->
  <section class="hero">
    <img src="plakat.png" alt="Plakát" loading="lazy">
  </section>

  <!-- SEKCE 2: FORMULÁŘ -->
  <section class="panel">
    <div class="card">
      <h1>Cena lístku 200 Kč</h1>

      <label for="name">Jméno a příjmení:</label>
      <input type="text" id="name" placeholder="Zadejte své jméno a příjmení">

      <label for="qty">Počet vstupenek:</label>
      <select id="qty">
        <option value="1" selected>1 ks</option>
        <option value="2">2 ks</option>
        <option value="3">3 ks</option>
        <option value="4">4 ks</option>
        <option value="5">5 ks</option>
        <option value="6">6 ks</option>
        <option value="7">7 ks</option>
        <option value="8">8 ks</option>
        <option value="9">9 ks</option>
        <option value="10">10 ks</option>
      </select>

      <div class="total">
        <div>Celkem k úhradě<br><small>200 Kč × <span id="qtty">1</span> ks</small></div>
        <div style="font-size:clamp(18px,2.6vw,28px)"><span id="sum">200</span> Kč</div>
      </div>
    </div>
  </section>

  <!-- SEKCE 3: QR KÓD -->
  <section class="qr-wrap">
    <div class="qr-box">
      <img id="qrImg" alt="QR kód platby" width="320" height="320" decoding="async" />
    </div>
    <div class="btns">
      <button id="dlQR" type="button">Stáhnout QR kód pro platbu</button>
      <button id="openQR" type="button">Otevřít QR v nové kartě</button>
    </div>
  </section>

<script>
/* ===== Konfigurace – měníš jen TENTO řádek ===== */
const ACCOUNT_BBAN = '8346955003/5500';   // tvar: [prefix-]číslo/banka (např. "19-1234567890/0800")

const TICKET_PRICE = 200;
const VARIABLE_SYMBOL = '2025';
const CURRENCY = 'CZK';

/* ===== Pomocné funkce UI ===== */
function amountCZK(qty){ return (Number(qty) * TICKET_PRICE).toFixed(2); }
function msgText(name, qty){
  if(!name) name = "Bez jména";
  const plural = qty == 1 ? "vstupenka" : (qty < 5 ? "vstupenky" : "vstupenek");
  return `${name} - celkem ${qty} ${plural}`;
}

/* ===== Převod domácího čísla účtu → IBAN (CZ) ===== */
/* Parse "prefix-account/bank" or "account/bank" */
function parseCzechAccount(str){
  str = String(str || '').replace(/\s|[\u00A0\u200B-\u200D]/g,''); // mezery, NBSP, ZW chars
  const [left, bank] = str.split('/');
  if(!left || !bank) throw new Error('Neplatný formát účtu. Použij "číslo/banka" nebo "prefix-číslo/banka".');

  let prefix = '0', account = left;
  if(left.includes('-')){ [prefix, account] = left.split('-'); }

  // jen číslice
  prefix  = String(prefix || '0').replace(/\D/g,'');
  account = String(account || '').replace(/\D/g,'');

  // padding: prefix max 6, account na 10
  if(prefix.length > 6) throw new Error('Prefix účtu je příliš dlouhý.');
  if(account.length > 10) throw new Error('Číslo účtu je příliš dlouhé.');
  prefix  = prefix.padStart(6, '0');
  account = account.padStart(10,'0');

  const bankCode = String(bank).replace(/\D/g,'').padStart(4,'0');
  return { bankCode, prefix, account };
}

/* Spočítá IBAN pro ČR z domácího účtu */
function czechToIBAN(str){
  const { bankCode, prefix, account } = parseCzechAccount(str);
  const bban = bankCode + prefix + account; // 4 + 6 + 10 = 20 znaků
  // IBAN: CZkk + BBAN, kde kk jsou kontrolní číslice (98 - mod97(...))
  const rearranged = bban + 'CZ00';
  const numeric = rearranged.replace(/[A-Z]/g, ch => (ch.charCodeAt(0)-55).toString()); // A=10,...Z=35

  // mod 97 pro dlouhý řetězec
  let remainder = 0;
  for (let i=0; i<numeric.length; i+=7){
    remainder = Number(String(remainder) + numeric.substr(i,7)) % 97;
  }
  const check = String(98 - remainder).padStart(2,'0');
  return 'CZ' + check + bban;
}

/* Vrátí, co má jít do SPD do "ACC:" (IBAN bez mezer) */
function toSPDAccount(bbanStr){
  return czechToIBAN(bbanStr).toUpperCase().replace(/[^A-Z0-9]/g,'');
}

/* ===== Sestavení SPD 1.0 ===== */
function buildSPD({acc, amount, vs, msg}){
  const p = ['SPD*1.0'];
  p.push('ACC:' + acc);
  if (amount) p.push('AM:' + amount);        // "200.00"
  p.push('CC:' + CURRENCY);                  // "CZK"
  if (vs) p.push('X-VS:' + String(vs).replace(/\D/g,'').slice(0,10));
  if (msg) p.push('MSG:' + msg.replace(/[\r\n]+/g,' ').slice(0,60));
  return p.join('*');
}

/* ===== QR vykreslení ===== */
function qrSize(){
  const box = document.querySelector('.qr-box');
  const w = Math.round((box && box.getBoundingClientRect().width) || 300);
  return Math.max(180, Math.min(600, w));
}
function setQRImage(spd){
  const size = qrSize();
  const url = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(spd)}&size=${size}x${size}&margin=1`;
  const img = document.getElementById('qrImg');
  img.src = url;
  img.width = size; img.height = size;
}

/* ===== UI logika ===== */
const nameEl = document.getElementById('name');
const qtyEl  = document.getElementById('qty');
const sumEl  = document.getElementById('sum');
const qttyEl = document.getElementById('qtty');
const dlQRBtn = document.getElementById('dlQR');
const openQRBtn = document.getElementById('openQR');

function render(){
  const qty = qtyEl.value;
  const name = nameEl.value.trim();
  const amount = amountCZK(qty);
  const msg = msgText(name, qty);

  const accIBAN = toSPDAccount(ACCOUNT_BBAN);  // ← spočítáme správný IBAN z "8346955003/5500"
  const spd = buildSPD({ acc: accIBAN, amount, vs: VARIABLE_SYMBOL, msg });

  sumEl.textContent = (Number(amount)).toLocaleString('cs-CZ', { maximumFractionDigits: 0 });
  qttyEl.textContent = qty;
  setQRImage(spd);
}

/* Stáhnout QR */
dlQRBtn.addEventListener('click', async ()=>{
  const img = document.getElementById('qrImg');
  try {
    const res = await fetch(img.src);
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'qr-platba.png';
    document.body.appendChild(a);
    a.click();
    a.remove();
  } catch(e) {
    window.open(img.src, '_blank');
  }
});

/* Otevřít QR v nové kartě */
openQRBtn.addEventListener('click', ()=>{
  const img = document.getElementById('qrImg');
  window.open(img.src, '_blank');
});

/* Události */
nameEl.addEventListener('input', render);
qtyEl.addEventListener('change', render);
window.addEventListener('resize', () => { clearTimeout(window._rT); window._rT = setTimeout(()=>render(), 150); });

/* Start */
render();
</script>
</body>
</html>
